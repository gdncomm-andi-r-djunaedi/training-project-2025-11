spring.application.name=gateway-service
server.port=8070

spring.data.redis.host=localhost
spring.data.redis.port=6379

# Rate Limiter Configuration (Redis-based)
# Default rate limits (can be overridden per route)
spring.cloud.gateway.redis-rate-limiter.replenishRate=5
spring.cloud.gateway.redis-rate-limiter.burstCapacity=10
spring.cloud.gateway.redis-rate-limiter.requestedTokens=1

# --- Swagger Doc Routes (Must come first for priority) ---

# Swagger UI Redirect (handles /swagger-ui.html to webjars)
spring.cloud.gateway.routes[0].id=swagger-ui-redirect
spring.cloud.gateway.routes[0].uri=http://localhost:8070
spring.cloud.gateway.routes[0].predicates[0]=Path=/swagger-ui.html
spring.cloud.gateway.routes[0].filters[0]=RedirectTo=302,/webjars/swagger-ui/index.html?configUrl=/v3/api-docs/swagger-config

# API Docs routes are now handled by OpenApiTransformController
# This controller transforms the service OpenAPI specs to use Gateway URLs

# Swagger Config Redirect (handles browser cache issue)
spring.cloud.gateway.routes[1].id=swagger-config-redirect
spring.cloud.gateway.routes[1].uri=http://localhost:8070
spring.cloud.gateway.routes[1].predicates[0]=Path=/api-docs/swagger-config
spring.cloud.gateway.routes[1].filters[0]=RedirectTo=302,/v3/api-docs/swagger-config

# --- Service Routes ---
# Authentication flow:
# Gateway /api/v1/auth/login → MemberService validates → Gateway generates JWT
# Gateway /api/v1/auth/logout → Gateway validates JWT
# Registration and other member operations go directly to MemberService

# Member Service Route
spring.cloud.gateway.routes[2].id=member-service
spring.cloud.gateway.routes[2].uri=http://localhost:8061
spring.cloud.gateway.routes[2].predicates[0]=Path=/api/v1/member/**
spring.cloud.gateway.routes[2].filters[0]=AuthenticationFilter
spring.cloud.gateway.routes[2].filters[1].name=RequestRateLimiter
spring.cloud.gateway.routes[2].filters[1].args.redis-rate-limiter.replenishRate=50
spring.cloud.gateway.routes[2].filters[1].args.redis-rate-limiter.burstCapacity=100
spring.cloud.gateway.routes[2].filters[1].args.redis-rate-limiter.requestedTokens=1

# Product Service
spring.cloud.gateway.routes[3].id=product-service
spring.cloud.gateway.routes[3].uri=http://localhost:8062
spring.cloud.gateway.routes[3].predicates[0]=Path=/api/v1/products/**
spring.cloud.gateway.routes[3].filters[0]=AuthenticationFilter
spring.cloud.gateway.routes[3].filters[1].name=RequestRateLimiter
spring.cloud.gateway.routes[3].filters[1].args.redis-rate-limiter.replenishRate=30
spring.cloud.gateway.routes[3].filters[1].args.redis-rate-limiter.burstCapacity=60
spring.cloud.gateway.routes[3].filters[1].args.redis-rate-limiter.requestedTokens=1

# Cart Service
spring.cloud.gateway.routes[4].id=cart-service
spring.cloud.gateway.routes[4].uri=http://localhost:8063
spring.cloud.gateway.routes[4].predicates[0]=Path=/api/v1/cart/**
spring.cloud.gateway.routes[4].filters[0]=AuthenticationFilter
spring.cloud.gateway.routes[4].filters[1].name=RequestRateLimiter
spring.cloud.gateway.routes[4].filters[1].args.redis-rate-limiter.replenishRate=40
spring.cloud.gateway.routes[4].filters[1].args.redis-rate-limiter.burstCapacity=80
spring.cloud.gateway.routes[4].filters[1].args.redis-rate-limiter.requestedTokens=1

# JWT Configuration
jwt.public-key-path=classpath:keys/public_key.pem
jwt.private-key-path=classpath:keys/private_key.pem
jwt.keys.directory=src/main/resources/keys
jwt.access-token.expiration=300000
jwt.refresh-token.expiration=604800000

# Member Service URL (for calling member service internally)
member.service.url=http://localhost:8061

logging.level.org.springframework.cloud.gateway=DEBUG
logging.level.org.springframework.security=DEBUG
logging.level.org.springframework.web.reactive=DEBUG

# SpringDoc Configuration
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.enabled=true
springdoc.swagger-ui.operationsSorter=method
springdoc.swagger-ui.tagsSorter=alpha
springdoc.swagger-ui.tryItOutEnabled=true
springdoc.packages-to-scan=com.dev.onlineMarketplace.gateway.controller

# Important: Explicitly set config URL and disable validator
springdoc.swagger-ui.config-url=/v3/api-docs/swagger-config
springdoc.swagger-ui.disable-swagger-default-url=true
springdoc.swagger-ui.validator-url=

# Aggregate multiple service API docs in Swagger UI
# Gateway's own APIs
springdoc.swagger-ui.urls[0].name=Gateway Authentication
springdoc.swagger-ui.urls[0].url=/v3/api-docs

# Member Service API docs
springdoc.swagger-ui.urls[1].name=Member Service
springdoc.swagger-ui.urls[1].url=/api/v1/member/v3/api-docs

# Product Service API docs
springdoc.swagger-ui.urls[2].name=Product Service
springdoc.swagger-ui.urls[2].url=/api/v1/products/api-docs

# Cart Service API docs
springdoc.swagger-ui.urls[3].name=Cart Service
springdoc.swagger-ui.urls[3].url=/api/v1/cart/api-docs

# Set the default selected API in dropdown
springdoc.swagger-ui.urls-primary-name=Gateway Authentication

# Actuator Configuration
management.endpoints.web.exposure.include=*
management.endpoint.gateway.enabled=true

# Gateway Security Configuration
# Define which endpoints are public (don't require authentication)
# Supports wildcards: /api/v1/products/** matches all product endpoints

# ============================================
# PUBLIC ENDPOINTS (No Authentication Required)
# ============================================

# --- Authentication & Registration ---
gateway.security.open-endpoints[0]=/api/v1/auth/login
gateway.security.open-endpoints[1]=/api/v1/auth/logout
gateway.security.open-endpoints[2]=/api/v1/member/register
gateway.security.open-endpoints[3]=/api/v1/member/login
gateway.security.open-endpoints[4]=/api/v1/member/logout

# --- Member Service (Public - Member List/Search) ---
gateway.security.open-endpoints[5]=/api/v1/member/members
gateway.security.open-endpoints[6]=/api/v1/member/members/search

# --- Product Service (Public Browsing) ---
# Allow public to view products without login
gateway.security.open-endpoints[7]=/api/v1/products/search
gateway.security.open-endpoints[8]=/api/v1/products/*

# --- Swagger/OpenAPI Documentation ---
gateway.security.open-endpoints[9]=/v3/api-docs/**
gateway.security.open-endpoints[10]=/api-docs/**
gateway.security.open-endpoints[11]=/swagger-ui/**
gateway.security.open-endpoints[12]=/swagger-ui.html
gateway.security.open-endpoints[13]=/webjars/**

# --- Service API Docs (for Swagger aggregation) ---
gateway.security.open-endpoints[14]=/api/v1/member/v3/api-docs
gateway.security.open-endpoints[15]=/api/v1/products/api-docs
gateway.security.open-endpoints[16]=/api/v1/cart/api-docs

# --- Monitoring & Health ---
gateway.security.open-endpoints[17]=/actuator/health
gateway.security.open-endpoints[18]=/actuator/info

# ============================================
# PROTECTED ENDPOINTS (Authentication Required)
# ============================================
# All endpoints NOT listed above require JWT token
# Examples of protected endpoints:
# - /api/v1/members/profile
# - /api/v1/members/update
# - /api/v1/cart/** (all cart operations)
# - /api/v1/products/create (admin only)
# - /api/v1/products/update (admin only)
# - /api/v1/products/delete (admin only)
