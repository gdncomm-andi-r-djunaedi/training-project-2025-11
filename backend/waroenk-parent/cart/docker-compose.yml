# ================================
# Cart Module docker-compose.yml
# Builds and runs cart service with MongoDB and Redis
# ================================

services:
  cart:
    image: waroenk-parent-cart:latest
    container_name: cart
    deploy:
      resources:
        limits:
          memory: 400M
        reservations:
          memory: 192M
    env_file:
      - .env
    networks:
      - shared
      - mongodb-net
      - redis-net
      - backend
    # Expose to host for development
    ports:
      - "8083:8083"   # Cart HTTP
      - "9092:9092"   # Cart gRPC
    environment:
      HTTP_REST_PORT: 8083
      JAVA_OPTS: ${JAVA_OPTS:--Xms256m -Xmx348m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -XX:+UseStringDeduplication}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-}
      # MongoDB config
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongodb:27017/cart}
      # Redis config (Standalone mode by default)
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      # To enable Sentinel mode, set these env vars:
      # REDIS_SENTINEL_MASTER: mymaster
      # REDIS_SENTINEL_NODES: sentinel-1:26379,sentinel-2:26379,sentinel-3:26379
      # Cart/Checkout config
      CHECKOUT_TTL_SECONDS: ${CHECKOUT_TTL_SECONDS:-900}
      CHECKOUT_USE_REDIS: ${CHECKOUT_USE_REDIS:-true}
      # gRPC Client addresses (use Docker service names)
      GRPC_CATALOG_ADDRESS: ${GRPC_CATALOG_ADDRESS:-static://catalog:9091}
      GRPC_MEMBER_ADDRESS: ${GRPC_MEMBER_ADDRESS:-static://member:9090}

networks:
  backend:
    name: backend
    external: true
  shared:
    name: shared-network
    external: true
  mongodb-net:
    name: mongodb
    external: true
  redis-net:
    name: redis-net
    external: true
