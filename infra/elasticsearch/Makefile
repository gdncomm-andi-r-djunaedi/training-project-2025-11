# ========================================================
# Environment Configuration
# ========================================================
include .env
export $(shell sed 's/=.*//' .env)

ES_CONTAINER=elasticsearch
KIBANA_CONTAINER=kibana

# ========================================================
# Docker Compose Commands
# ========================================================

.PHONY: up down restart logs ps clean

up:
	@echo "ğŸš€ Starting Elasticsearch + Kibana..."
	docker-compose up -d

down:
	@echo "ğŸ›‘ Stopping stack..."
	docker-compose down

restart:
	@echo "ğŸ”„ Restarting all services..."
	docker-compose restart

logs:
	docker-compose logs -f

ps:
	docker-compose ps

clean:
	@echo "ğŸ”¥ Removing containers, volumes, network..."
	docker-compose down -v --remove-orphans

# ========================================================
# Elasticsearch Security Commands
# ========================================================

password-reset:
	@echo "ğŸ” Resetting Elasticsearch password..."
	docker exec -it $(ES_CONTAINER) /usr/share/elasticsearch/bin/elasticsearch-reset-password -u $(ELASTIC_USER) -i

token:
	@echo "ğŸŸ Generating Kibana enrollment token..."
	docker exec -it $(ES_CONTAINER) /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana

ca:
	@echo "ğŸ“„ Printing root SSL certificate..."
	docker exec -it $(ES_CONTAINER) cat /usr/share/elasticsearch/config/certs/http_ca.crt

# ========================================================
# Status & Diagnostics
# ========================================================

health:
	@echo "ğŸ“Š Checking cluster health..."
	curl -k -u $(ELASTIC_USER):$(ELASTIC_PASSWORD) https://localhost:9200/_cluster/health?pretty

version:
	@echo "ğŸ” Elasticsearch version:"
	curl -k -u $(ELASTIC_USER):$(ELASTIC_PASSWORD) https://localhost:9200

kibana-version:
	@echo "ğŸ” Kibana version:"
	curl -k -u $(ELASTIC_USER):$(ELASTIC_PASSWORD) http://localhost:5601/api/status


# ========================================================
# Utility
# ========================================================

fix-permissions:
	@echo "ğŸ”§ Fixing folder permissions..."
	sudo chown -R 1000:1000 data elasticsearch kibana certs
