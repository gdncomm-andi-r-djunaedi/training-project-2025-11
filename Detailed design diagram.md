
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           EXTERNAL CLIENT                           â”‚
â”‚                    (Browser, Mobile App, Postman)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ HTTP Request
                                 â”‚ Authorization: Bearer <token>
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API GATEWAY (Port 8089)                     â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              FILTER CHAIN (Executes in Order)                  â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  1ï¸âƒ£ JwtAuthenticationFilter (Order=1)                          â”‚ â”‚
â”‚  â”‚     â””â”€> Validates JWT token                                    â”‚ â”‚
â”‚  â”‚     â””â”€> Extracts user info (memberId, email, role)             â”‚ â”‚
â”‚  â”‚     â””â”€> Sets request attributes (X-User-Id, X-User-Email...)   â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  2ï¸âƒ£ RateLimitFilter (Order=2)                                  â”‚ â”‚
â”‚  â”‚     â””â”€> Checks Redis for rate limit                            â”‚ â”‚
â”‚  â”‚     â””â”€> Limits: 300 requests/minute per user                   â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  3ï¸âƒ£ SecurityHeadersFilter (Order=3)                            â”‚ â”‚
â”‚  â”‚     â””â”€> Adds security headers (CSP, X-Frame-Options, etc.)     â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  4ï¸âƒ£ RequestLoggingFilter (Order=4)                             â”‚ â”‚
â”‚  â”‚     â””â”€> Logs request/response details                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      ROUTING LOGIC                             â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  /api/v1/members/**   â†’ Member Service (8090)                  â”‚ â”‚
â”‚  â”‚  /api/v1/products/**  â†’ Product Service (8083)                 â”‚ â”‚
â”‚  â”‚  /api/v1/cart/**      â†’ Cart Service (8084)                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚               â”‚              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                â”‚    Member     â”‚  â”‚  Product  â”‚  â”‚    Cart    â”‚
                â”‚   Service     â”‚  â”‚  Service  â”‚  â”‚  Service   â”‚
                â”‚  (Port 8090)  â”‚  â”‚(Port 8083)â”‚  â”‚(Port 8084) â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Generates JWT tokens
                        â”‚ (login, register, refresh)
                        â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Database     â”‚
                â”‚  (Users Data)  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REDIS (Port 6379)                               â”‚
â”‚                                                                      â”‚
â”‚  â€¢ Rate Limiting (rate:limit:user:<userId>)                          â”‚
â”‚  â€¢ Token Denylist (token:denied:<token>)                             â”‚
â”‚  â€¢ Cache (TTL: 5 minutes)                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜




## 2. Complete Request Flow - Cart API Example
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ POST /api/v1/cart/items
     â”‚ Authorization: Bearer eyJhbGc...
     â”‚ Body: { "productId": "123", "quantity": 2 }
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GATEWAY - Filter Chain                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  1ï¸âƒ£  JwtAuthenticationFilter                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â”‚
     â”œâ”€> Check: Is path public? â†’ NO
     â”‚
     â”œâ”€> Check: Is optional auth? â†’ YES (/api/v1/cart/**)
     â”‚
     â”œâ”€> Extract token: "eyJhbGc..."
     â”‚
     â”œâ”€> Parse token with JwtUtil.parseToken()
     â”‚   â””â”€> Validates signature with JWT secret
     â”‚   â””â”€> Parses claims (memberId, email, role, type, exp)
     â”‚
     â”œâ”€> Validate token type: claims.get("type") == "access" âœ“
     â”‚
     â”œâ”€> Check expiration: claims.getExpiration() > now() âœ“
     â”‚
     â”œâ”€> Extract user info:
     â”‚   â€¢ memberId: "user123"
     â”‚   â€¢ email: "john@example.com"
     â”‚   â€¢ role: "USER"
     â”‚
     â”œâ”€> Set request attributes:
     â”‚   request.setAttribute("X-User-Id", "user123")
     â”‚   request.setAttribute("X-User-Email", "john@example.com")
     â”‚   request.setAttribute("X-User-Role", "USER")
     â”‚   request.setAttribute("X-User-Type", "authenticated")
     â”‚   request.setAttribute("X-Has-Valid-Token", "true")
     â”‚
     â””â”€> Continue to next filter âœ“
     â”‚
     â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  2ï¸âƒ£  RateLimitFilter                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â”‚
     â”œâ”€> Get user ID from request attributes: "user123"
     â”‚
     â”œâ”€> Check Redis: GET rate:limit:user:user123
     â”‚   â””â”€> Current count: 245/300
     â”‚
     â”œâ”€> Increment counter: INCR rate:limit:user:user123
     â”‚   â””â”€> New count: 246/300
     â”‚
     â”œâ”€> Add response headers:
     â”‚   X-RateLimit-Limit: 300
     â”‚   X-RateLimit-Remaining: 54
     â”‚   X-RateLimit-Reset: <timestamp>
     â”‚
     â””â”€> Continue to next filter âœ“
     â”‚
     â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  3ï¸âƒ£  SecurityHeadersFilter                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â”‚
     â”œâ”€> Add security headers to response:
     â”‚   X-Content-Type-Options: nosniff
     â”‚   X-Frame-Options: DENY
     â”‚   X-XSS-Protection: 1; mode=block
     â”‚   Content-Security-Policy: default-src 'self'...
     â”‚
     â””â”€> Continue to next filter âœ“
     â”‚
     â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  4ï¸âƒ£  RequestLoggingFilter                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â”‚
     â”œâ”€> Log request:
     â”‚   [REQUEST] POST /api/v1/cart/items
     â”‚   User: user123 (john@example.com)
     â”‚   IP: 192.168.1.100
     â”‚
     â””â”€> Continue to routing âœ“
     â”‚
     â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  GATEWAY ROUTING - Cart Service Route                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â”‚
     â”œâ”€> Match path: /api/v1/cart/** â†’ cart_service route
     â”‚
     â”œâ”€> Target URI: http://localhost:8084/api/v1/cart/items
     â”‚
     â”œâ”€> Add headers from request attributes:
     â”‚   X-Gateway: API-Gateway
     â”‚   X-User-Id: user123
     â”‚   X-User-Email: john@example.com
     â”‚   X-User-Role: USER
     â”‚   X-User-Type: authenticated
     â”‚   X-Has-Valid-Token: true
     â”‚
     â””â”€> Forward request to Cart Service
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CART SERVICE (8084)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€> Receive request with headers
     â”‚
     â”œâ”€> Read X-User-Id header: "user123"
     â”‚
     â”œâ”€> Add item to cart for user123:
     â”‚   INSERT INTO cart_items (user_id, product_id, quantity)
     â”‚   VALUES ('user123', '123', 2)
     â”‚
     â””â”€> Return response: 201 Created
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GATEWAY - Response                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€> RequestLoggingFilter logs response
     â”‚
     â”œâ”€> SecurityHeaders already added
     â”‚
     â””â”€> Return to client: 201 Created
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚ â† Response: { "cartId": "cart123", "totalItems": 3 }
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


## 3. Token Validation Decision Tree
                        Request Arrives
                              â”‚
                              â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Check Endpoint Type   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚               â”‚               â”‚
              â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   PUBLIC     â”‚  â”‚   OPTIONAL   â”‚  â”‚  PROTECTED   â”‚
    â”‚   ENDPOINT   â”‚  â”‚     AUTH     â”‚  â”‚   ENDPOINT   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                  â”‚
           â”‚                 â”‚                  â”‚
    /api/v1/auth/login      â”‚          /api/v1/members/**
    /api/v1/products/**     â”‚
           â”‚                 â”‚                  â”‚
           â–¼                 â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Skip Token   â”‚  â”‚ Check Token  â”‚  â”‚ Require Tokenâ”‚
    â”‚ Validation   â”‚  â”‚  (Optional)  â”‚  â”‚ (Mandatory)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                  â”‚
           â–¼                 â”‚                  â”‚
      Continue to            â”‚                  â”‚
       Service               â”‚                  â”‚
                             â–¼                  â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Token Present?   â”‚  â”‚Token Present?â”‚
                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚        â”‚               â”‚
                   YES  â”‚        â”‚ NO        NO  â”‚
                        â”‚        â”‚               â–¼
                        â”‚        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚        â”‚         â”‚ Return   â”‚
                        â”‚        â”‚         â”‚   401    â”‚
                        â”‚        â”‚         â”‚Unauthorized
                        â”‚        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚        â”‚
                        â”‚        â–¼              â”‚
                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                        â”‚  â”‚ Treat as â”‚         â”‚
                        â”‚  â”‚  Guest   â”‚         â”‚
                        â”‚  â”‚          â”‚         â”‚
                        â”‚  â”‚ X-User-Idâ”‚         â”‚
                        â”‚  â”‚= guest-  â”‚         â”‚
                        â”‚  â”‚  uuid    â”‚         â”‚
                        â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
                        â”‚       â”‚               â”‚
                        â–¼       â”‚               â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Parse Token     â”‚  â”‚ Parse Token  â”‚
                   â”‚ with JwtUtil    â”‚  â”‚ with JwtUtil â”‚
                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                      â”‚
                   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                   â”‚ Valid?  â”‚            â”‚ Valid?  â”‚
                   â””â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”˜            â””â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”˜
              YES    â”‚    â”‚ NO       YES    â”‚    â”‚ NO
                     â”‚    â”‚                 â”‚    â”‚
                     â”‚    â–¼                 â”‚    â–¼
                     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  â”‚ Treat as â”‚        â”‚  â”‚ Return   â”‚
                     â”‚  â”‚  Guest   â”‚        â”‚  â”‚   401    â”‚
                     â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚       â”‚              â”‚
                     â–¼       â”‚              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Check Token Type â”‚  â”‚ Check Token  â”‚
              â”‚ (access/refresh) â”‚  â”‚     Type     â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                       â”‚
              â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
              â”‚Access?  â”‚             â”‚Access?  â”‚
              â””â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”˜             â””â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”˜
         YES    â”‚    â”‚ NO        YES    â”‚    â”‚ NO
                â”‚    â”‚                  â”‚    â”‚
                â”‚    â–¼                  â”‚    â–¼
                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  â”‚ Treat as â”‚         â”‚  â”‚ Return   â”‚
                â”‚  â”‚  Guest   â”‚         â”‚  â”‚   401    â”‚
                â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚       â”‚               â”‚
                â–¼       â”‚               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Check Expiration â”‚   â”‚ Check Exp.   â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                        â”‚
         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
         â”‚Expired? â”‚              â”‚Expired? â”‚
         â””â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”˜              â””â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”˜
     NO    â”‚    â”‚ YES         NO    â”‚    â”‚ YES
           â”‚    â”‚                   â”‚    â”‚
           â”‚    â–¼                   â”‚    â–¼
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  â”‚ Treat as â”‚          â”‚  â”‚ Return   â”‚
           â”‚  â”‚  Guest   â”‚          â”‚  â”‚   401    â”‚
           â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚       â”‚                â”‚
           â–¼       â”‚                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Set Authenticated â”‚   â”‚ Set Auth     â”‚
    â”‚ User Context      â”‚   â”‚ Context      â”‚
    â”‚                   â”‚   â”‚              â”‚
    â”‚ X-User-Id: user123â”‚   â”‚X-User-Id:... â”‚
    â”‚ X-User-Type:      â”‚   â”‚X-User-Type:  â”‚
    â”‚  authenticated    â”‚   â”‚authenticated â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â–¼                         â–¼
    Continue to                Continue to
    Cart Service              Downstream Service
    (with user info)          (with user info)




## 4. Scenario-Based Flow Comparison
### Scenario A: Login (Token Generation)
Client                Gateway                  Gateway          Postgres
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚ POST /api/v1/auth/login                      â”‚                  â”‚
  â”‚ {"email":"..","pw":".."}                     â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Public endpoint?      â”‚                  â”‚
  â”‚                      â”‚ âœ“ Skip JWT check      â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Forward request       â”‚                  â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚                       â”‚ Validate         â”‚
  â”‚                      â”‚                       â”‚ credentials      â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚                       â”‚ Generate JWT     â”‚
  â”‚                      â”‚                       â”‚ tokens:          â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚                       â”‚ accessToken =    â”‚
  â”‚                      â”‚                       â”‚ Jwts.builder()   â”‚
  â”‚                      â”‚                       â”‚   .subject(id)   â”‚
  â”‚                      â”‚                       â”‚   .claim("email")â”‚
  â”‚                      â”‚                       â”‚   .claim("role") â”‚
  â”‚                      â”‚                       â”‚   .claim("type", â”‚
  â”‚                      â”‚                       â”‚    "access")     â”‚
  â”‚                      â”‚                       â”‚   .expiration(   â”‚
  â”‚                      â”‚                       â”‚    15 min)       â”‚
  â”‚                      â”‚                       â”‚   .signWith(key) â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Response with tokens  â”‚                  â”‚
  â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚ 200 OK               â”‚                       â”‚                  â”‚
  â”‚ {"accessToken":"...",                        â”‚                  â”‚
  â”‚  "refreshToken":".."}                        â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
### Scenario B: Cart API with Valid Token
Client                Gateway              Cart Service           Mongo
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚ POST /api/v1/cart/items                      â”‚                  â”‚
  â”‚ Authorization: Bearer <valid_token>          â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Optional auth?        â”‚                  â”‚
  â”‚                      â”‚ âœ“ Yes                 â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Token present?        â”‚                  â”‚
  â”‚                      â”‚ âœ“ Yes                 â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Parse token           â”‚                  â”‚
  â”‚                      â”‚ Extract: user123      â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Check rate limit      â”‚                  â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                      â”‚                       â”‚    GET rate:     â”‚
  â”‚                      â”‚                       â”‚    limit:user:   â”‚
  â”‚                      â”‚                       â”‚    user123       â”‚
  â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚                       â”‚    246/300       â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Forward with headers  â”‚                  â”‚
  â”‚                      â”‚ X-User-Id: user123    â”‚                  â”‚
  â”‚                      â”‚ X-User-Type:authenticated                â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚                       â”‚ Add to user's    â”‚
  â”‚                      â”‚                       â”‚ cart (user123)   â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ 201 Created           â”‚                  â”‚
  â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
  â”‚ 201 Created          â”‚                       â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                  â”‚
### Scenario C: Cart API with Expired Token
Client                Gateway              Cart Service           Mongo
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚ POST /api/v1/cart/items                      â”‚                  â”‚
  â”‚ Authorization: Bearer <expired_token>        â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Optional auth?        â”‚                  â”‚
  â”‚                      â”‚ âœ“ Yes                 â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Token present?        â”‚                  â”‚
  â”‚                      â”‚ âœ“ Yes                 â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Parse token           â”‚                  â”‚
  â”‚                      â”‚ Check expiration      â”‚                  â”‚
  â”‚                      â”‚ âœ— EXPIRED!            â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Set GUEST context     â”‚                  â”‚
  â”‚                      â”‚ X-User-Id:guest-uuid  â”‚                  â”‚
  â”‚                      â”‚ X-User-Type: guest    â”‚                  â”‚
  â”‚                      â”‚ X-Has-Valid-Token:    â”‚                  â”‚
  â”‚                      â”‚ false                 â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Forward with headers  â”‚                  â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚                       â”‚ Add to GUEST     â”‚
  â”‚                      â”‚                       â”‚ cart (guest-uuid)â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ 201 Created           â”‚                  â”‚
  â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
  â”‚ 201 Created          â”‚                       â”‚                  â”‚
  â”‚ (but guest cart!)    â”‚                       â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                  â”‚
### Scenario D: Protected API with Expired Token
Client                Gateway                   Gateway         Redis
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚ GET /api/v1/members/profile                  â”‚                  â”‚
  â”‚ Authorization: Bearer <expired_token>        â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Protected endpoint?   â”‚                  â”‚
  â”‚                      â”‚ âœ“ Yes (mandatory)     â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Token present?        â”‚                  â”‚
  â”‚                      â”‚ âœ“ Yes                 â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Parse token           â”‚                  â”‚
  â”‚                      â”‚ Check expiration      â”‚                  â”‚
  â”‚                      â”‚ âœ— EXPIRED!            â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚                      â”‚ Return 401            â”‚                  â”‚
  â”‚ 401 Unauthorized     â”‚                       â”‚                  â”‚
  â”‚ {"error":"Token      â”‚                       â”‚                  â”‚
  â”‚  has expired"}       â”‚                       â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                  â”‚
  â”‚                      â”‚                       â”‚                  â”‚
  â”‚ (Request never reaches Member Service)       â”‚                  â”‚
### Summary Table
| Scenario | Token State | Endpoint Type | What Happens | Cart Behavior |
|----------|-------------|---------------|--------------|---------------|
| Logged in | Valid token | Optional Auth | âœ… Authenticated user | User's cart |
| No token | No token | Optional Auth | ğŸ‘¤ Guest user | Guest cart |
| Expired token | Expired | Optional Auth | ğŸ‘¤ Guest user | Guest cart |
| After logout | Should be denied | Optional Auth | âš ï¸ **Currently still works** | User's cart (BUG!) |
| Malformed token | Invalid | Optional Auth | ğŸ‘¤ Guest user | Guest cart |
| Valid token | Valid | Protected | âœ… Authenticated user | N/A |
| Expired token | Expired | Protected | âŒ 401 Unauthorized | N/A |
| No token | No token | Protected | âŒ 401 Unauthorized | N/A |



## 5. Key Components Interaction Map
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         JWT UTILITIES                            â”‚
â”‚                                                                  â”‚
â”‚  JwtUtil.java                                                    â”‚
â”‚  â”œâ”€ parseToken(token) â†’ Claims                                   â”‚
â”‚  â”œâ”€ isAccessToken(claims) â†’ boolean                              â”‚
â”‚  â”œâ”€ isTokenExpired(claims) â†’ boolean                             â”‚
â”‚  â”œâ”€ getMemberId(claims) â†’ String                                 â”‚
â”‚  â”œâ”€ getEmail(claims) â†’ String                                    â”‚
â”‚  â””â”€ getRole(claims) â†’ String                                     â”‚
â”‚                                                                  â”‚
â”‚  Used by: JwtAuthenticationFilter                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    JWT AUTHENTICATION FILTER                     â”‚
â”‚                                                                  â”‚
â”‚  Decision Logic:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ IF public endpoint    â†’ Skip validation                    â”‚  â”‚
â”‚  â”‚ IF optional auth      â†’ Validate if present, else guest    â”‚  â”‚
â”‚  â”‚ IF protected endpoint â†’ Validate (mandatory), else 401     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Sets Request Attributes:                                        â”‚
â”‚  â€¢ X-User-Id                                                     â”‚
â”‚  â€¢ X-User-Email                                                  â”‚
â”‚  â€¢ X-User-Role                                                   â”‚
â”‚  â€¢ X-User-Type (authenticated/guest)                             â”‚
â”‚  â€¢ X-Has-Valid-Token (true/false)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      RATE LIMIT FILTER                           â”‚
â”‚                                                                  â”‚
â”‚  Redis Key Pattern: rate:limit:user:<userId>                     â”‚
â”‚  Limit: 300 requests/minute                                      â”‚
â”‚  Scope: Per-user (uses X-User-Id from request attributes)        â”‚
â”‚                                                                  â”‚
â”‚  Response Headers:                                               â”‚
â”‚  â€¢ X-RateLimit-Limit: 300                                        â”‚
â”‚  â€¢ X-RateLimit-Remaining: <remaining>                            â”‚
â”‚  â€¢ X-RateLimit-Reset: <timestamp>                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SECURITY HEADERS FILTER                       â”‚
â”‚                                                                 â”‚
â”‚  Adds Security Headers:                                         â”‚
â”‚  â€¢ X-Content-Type-Options: nosniff                              â”‚
â”‚  â€¢ X-Frame-Options: DENY                                        â”‚
â”‚  â€¢ X-XSS-Protection: 1; mode=block                              â”‚
â”‚  â€¢ Strict-Transport-Security: max-age=31536000                  â”‚
â”‚  â€¢ Content-Security-Policy: default-src 'self'...               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   REQUEST LOGGING FILTER                        â”‚
â”‚                                                                 â”‚
â”‚  Logs:                                                          â”‚
â”‚  â€¢ Request: Method, URI, User, IP, Trace ID                     â”‚
â”‚  â€¢ Response: Status Code, Duration                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GATEWAY ROUTING                             â”‚
â”‚                                                                  â”‚
â”‚  Routes from GatewayConfig.java:                                 â”‚
â”‚                                                                  â”‚
â”‚  1. /api/v1/members/**  â†’ http://localhost:8090 (Member)         â”‚
â”‚  2. /api/v1/products/** â†’ http://localhost:8083 (Product)        â”‚
â”‚  3. /api/v1/cart/**     â†’ http://localhost:8084 (Cart)           â”‚
â”‚                                                                  â”‚
â”‚  Adds to all requests:                                           â”‚
â”‚  â€¢ X-Gateway: API-Gateway                                        â”‚
â”‚                                                                  â”‚
â”‚  Special for Cart Service:                                       â”‚
â”‚  â€¢ Forwards all user context headers from request attributes     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”˜
## 6. JWT Token Structure
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    JWT TOKEN STRUCTURE                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyMTIzIiwiZW1...
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            Header           Payload (Claims)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HEADER                                                           â”‚
â”‚ {                                                                â”‚
â”‚   "alg": "HS256",     // Algorithm                               â”‚
â”‚   "typ": "JWT"        // Type                                    â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PAYLOAD (Claims)                                                 â”‚
â”‚ {                                                                â”‚
â”‚   "sub": "user123",              // Subject (memberId)           â”‚
â”‚   "email": "john@example.com",   // Custom claim                 â”‚
â”‚   "role": "USER",                // Custom claim                 â”‚
â”‚   "type": "access",              // Token type (access/refresh)  â”‚
â”‚   "iat": 1701432000,             // Issued at                    â”‚
â”‚   "exp": 1701432900              // Expiration (15 min later)    â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SIGNATURE                                                        â”‚
â”‚                                                                  â”‚
â”‚ HMACSHA256(                                                      â”‚
â”‚   base64UrlEncode(header) + "." + base64UrlEncode(payload),      â”‚
â”‚   secret_key                                                     â”‚
â”‚ )                                                                â”‚
â”‚                                                                  â”‚
â”‚ Secret from config: jwt.secret (256-bit key)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
### Token Validation Process
1. **Signature Verification**: Gateway validates the token signature using the shared JWT secret
2. **Expiration Check**: Ensures token is not expired (15 minutes for access tokens)
3. **Type Validation**: Verifies the token type is "access" (not "refresh")
4. **Claims Extraction**: Extracts user information (memberId, email, role) from claims
5. **Context Propagation**: Forwards user info as headers to downstream services


## 7. Configuration Summary
### Endpoint Types Configuration
```yaml
gateway:
  # Public Endpoints (NO token required)
  public-endpoints:
    - /api/v1/auth/login
    - /api/v1/auth/register
    - /api/v1/auth/refresh
    - /api/v1/products/**
    - /health
    - /actuator/**
    - /swagger-ui/**
    - /v3/api-docs/**

  # Optional Auth Endpoints (token optional, works as guest if invalid)
  optional-auth-endpoints:
    - /api/v1/cart/**

  # Protected Endpoints (token REQUIRED)
  # Any endpoint NOT in the above lists requires a valid token
  # Examples:
  #   - /api/v1/members/**
  #   - Any other custom endpoints
```
### JWT Configuration
```yaml
jwt:
  secret: ${JWT_SECRET:default-256-bit-secret-key}
  access-token-expiration: 900000        # 15 minutes
  refresh-token-expiration: 2592000000   # 30 days
```
### Rate Limiting Configuration
```yaml
rate-limit:
  enabled: true
  default-limit: 300      # requests per minute
  per-user: true          # rate limit per user
  per-ip: false           # not IP-based
```
### Service URLs
```yaml
services:
  member:
    url: ${MEMBER_SERVICE_URL:http://localhost:8090}
  product:
    url: ${PRODUCT_SERVICE_URL:http://localhost:8083}
  cart:
    url: ${CART_SERVICE_URL:http://localhost:8084}
```
### Redis Configuration
```yaml
spring:
  data:
    redis:
      host: localhost       # or 'redis' in Docker
      port: 6379
      timeout: 2000ms
```
### CORS Configuration
```yaml
cors:
  allowed-origins:
    - http://localhost:3000    # React dev
    - http://localhost:4200    # Angular dev
    - http://localhost:8089    # Gateway (for Swagger)
  allowed-methods:
    - GET
    - POST
    - PUT
    - DELETE
    - OPTIONS
  allow-credentials: true
  max-age: 3600
```
---



##  Troubleshooting Guide
### Common Issues
#### 1. "Token has expired" Error
**Cause**: Access token lifetime is 15 minutes
**Solution**:
- Frontend should use refresh token to get new access token
- Call `POST /api/v1/auth/refresh` with refresh token
- Update stored access token
#### 2. "Invalid token signature" Error
**Cause**: JWT secret mismatch between Member Service (generator) and Gateway (validator)
**Check**:
```bash
# Gateway JWT secret
grep "jwt.secret" src/main/resources/application.yml

# Member Service JWT secret (should match!)
grep "jwt.secret" ../member-service/src/main/resources/application.yml
```
**Solution**: Ensure both services use the same JWT secret
#### 3. Rate Limit Exceeded (429 Error)
**Cause**: User exceeded 300 requests/minute
**Check Response Headers**:
```
X-RateLimit-Limit: 300
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1701432900000
```
**Solution**:
- Wait until reset time
- Frontend should implement exponential backoff
- Consider increasing limit in `application.yml` if legitimate use case
#### 4. CORS Error
**Symptom**: Browser blocks request with CORS error
**Solution**: Add origin to `application.yml`:
```yaml
cors:
  allowed-origins:
    - http://your-frontend-domain:port
```
#### 5. Redis Connection Error
**Symptom**: Rate limiting or caching fails
**Check**:
```bash
# Test Redis connection
redis-cli ping
# Should return: PONG

# Check gateway logs
tail -f logs/gateway.log | grep "Redis"
```
**Solution**:
- Ensure Redis is running: `docker-compose up redis` or `redis-server`
- Check Redis host/port in `application.yml`
#### 6. Service Unavailable (503)
**Cause**: Downstream service (Member/Product/Cart) is not running
**Check**:
```bash
# Check if services are running
curl http://localhost:8090/health  # Member
curl http://localhost:8083/health  # Product
curl http://localhost:8084/health  # Cart
```
**Solution**: Start the required downstream service
### Debugging Tips
#### Enable Debug Logging
Add to `application.yml`:
```yaml
logging:
  level:
    com.blibli.gdn.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
```
#### View Request/Response Headers
Check `RequestLoggingFilter` logs for detailed request information including:
- User ID
- Request path
- Response status
- Duration
#### Test Token Locally
```bash
# Decode JWT token (without validation)
echo "YOUR_TOKEN" | cut -d "." -f2 | base64 -d | jq

# Check expiration
# "exp" is Unix timestamp - compare with current time
date +%s  # Current timestamp
```
#### Monitor Redis Keys
```bash
# Connect to Redis
redis-cli

# Check rate limit keys
KEYS rate:limit:*

# Check denylist keys
KEYS token:denied:*

# Get specific user's rate limit
GET rate:limit:user:user123

# Get TTL (time to live)
TTL rate:limit:user:user123
```
---


## Quick Reference
### Filter Execution Order
1. `JwtAuthenticationFilter` (Order=1) - Token validation
2. `RateLimitFilter` (Order=2) - Rate limiting
3. `SecurityHeadersFilter` (Order=3) - Security headers
4. `RequestLoggingFilter` (Order=4) - Logging
### Request Headers (Forwarded to Services)
- `X-Gateway`: "API-Gateway"
- `X-User-Id`: Member ID or guest UUID
- `X-User-Email`: User email (empty for guest)
- `X-User-Role`: User role or "GUEST"
- `X-User-Type`: "authenticated" or "guest"
- `X-Has-Valid-Token`: "true" or "false"
### Response Headers
- `X-RateLimit-Limit`: Maximum requests allowed
- `X-RateLimit-Remaining`: Requests remaining
- `X-RateLimit-Reset`: Timestamp when limit resets
- Security headers (CSP, X-Frame-Options, etc.)
### Redis Key Patterns
- Rate limiting: `rate:limit:user:<userId>`
- Token denylist: `token:denied:<token>`
- Cache: Various application-specific keys
---






